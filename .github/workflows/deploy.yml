name: Deploy to Windows Server

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: windows-latest  # –ú–µ–Ω—è–µ–º –Ω–∞ Windows runner

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.ASG_SERVER }}

    - name: Configure SSH
      run: |
        New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\.ssh"
        ssh-keyscan -t ed25519 193.239.161.50 | Out-File -Append "$env:USERPROFILE\.ssh\known_hosts"
        icacls "$env:USERPROFILE\.ssh\github-actions-key" /reset /grant:r "$env:USERNAME:(R)"

    - name: Deploy Application
      run: |
        $commands = @(
            "echo 'üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞...'",
            "sc stop ASGService || echo '–°–µ—Ä–≤–∏—Å —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'",
            "sc delete ASGService || echo '–°–µ—Ä–≤–∏—Å –Ω–µ –Ω–∞–π–¥–µ–Ω'",
            "echo 'üì¶ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞...'",
            "rmdir /s /q C:\ASGBuilds || echo '–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'",
            "mkdir C:\ASGBuilds",
            "echo '‚¨áÔ∏è –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞...'",
            "git clone https://github.com/KeFFiA/ASG.git C:\ASGBuilds",
            "echo 'üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...'",
            "cd C:\ASGBuilds",
            "python -m venv venv",
            "call .\venv\Scripts\activate",
            "pip install -r requirements.txt",
            "echo 'üîß –°–æ–∑–¥–∞–Ω–∏–µ Windows-—Å–ª—É–∂–±—ã...'",
            "sc create ASGService binPath= '\""C:\ASGBuilds\venv\Scripts\python.exe\"" C:\ASGBuilds\main.py' start= auto",
            "echo 'üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞...'",
            "sc start ASGService",
            "echo '‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!'"
        )
        ssh -i "$env:USERPROFILE\.ssh\github-actions-key" Administrator@193.239.161.50 "$($commands -join '; ')"