name: Deploy to Windows Server

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Debug SSH Key
      run: echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64

    - name: Deploy to Windows Server via SSH
      uses: appleboy/ssh-action@master
      with:
        host: 193.239.161.50
        username: Administrator
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞..."
          sc stop ASGService || echo "–°–µ—Ä–≤–∏—Å —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
          sc delete ASGService || echo "–°–µ—Ä–≤–∏—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"

          echo "üì¶ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞..."
          rmdir /s /q C:\ASGBuilds || echo "–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
          mkdir C:\ASGBuilds

          echo "‚¨áÔ∏è –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞..."
          git clone https://github.com/KeFFiA/ASG.git C:\ASGBuilds

          echo "üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          cd C:\ASGBuilds
          python -m venv venv
          .\venv\Scripts\pip install -r requirements.txt

          echo "üîß –°–æ–∑–¥–∞–Ω–∏–µ Windows-—Å–ª—É–∂–±—ã..."
          sc create ASGService binPath= "C:\ASGBuilds\venv\Scripts\python.exe C:\ASGBuilds\main.py" start= auto
          
          echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞..."
          sc start ASGService

          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
